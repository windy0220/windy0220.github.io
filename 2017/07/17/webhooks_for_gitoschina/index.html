<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用码云的WebHooks实现网站的自动部署 · 大马的个人网站</title><meta name="description" content="使用码云的WebHooks实现网站的自动部署 - 大马"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://bigma.cc/atom.xml" title="大马的个人网站"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/avater.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">日志</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/1000/01/01/实验室/" target="_self" class="nav-list-link">实验室</a></li><li class="nav-list-item"><a href="http://weibo.com/80yang" target="_blank" class="nav-list-link">微博</a></li><li class="nav-list-item"><a href="https://github.com/windy0220" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用码云的WebHooks实现网站的自动部署</h1><div class="post-info">2017年7月17日</div><div class="post-content"><p>码云上提供了一个WebHooks功能（其实github也有），原理就是在本地push的时候码云的WebHooks会向远程服务器进行post请求，这个post还可以带上一个密码，防止被恶意post。<br><a id="more"></a></p>
<p>另外WebHooks还支持push, tag push, lssue 等共5种触发方式。</p>
<p>我想实现的是本地 tag push之后 服务器的本地仓库执行pull操作，从而实现网站的自动部署。使用tag push的原因是我并不想每次push都进行部署。</p>
<p>下面就一步一步来实现这个过程。</p>
<p>1.首先在码云上创建一个项目，项目中只放 README.md，因为我们只是先实验下这样就够了。</p>
<p>2.将这个项目clone到本地及服务器</p>
<p>3.在服务器端创建一个pull.php文件，放到一个可以访问的网站目录，方便WebHooks进行post操作。php这里我们使用了shell_exec方法。在访问到该php文件后会执行pull.sh脚本。</p>
<p>shell_exec 默认是关闭的，要从php.ini中开启<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/<span class="built_in">local</span>/php/etc/php.ini</span><br></pre></td></tr></table></figure></p>
<p>搜索disable_function 将其中的 exec 和 shell_exec 删除。</p>
<p>这里尽量使用绝对路径，我使用了PHP的shell_exec函数，当然还可以使用exec system等函数。</p>
<p><em>pull.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$output = shell_exec(<span class="string">"/usr/bin/sudo /root/pull.sh"</span>);</span><br><span class="line"><span class="keyword">echo</span> $output;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><em>pull.sh</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">cd</span> /data/wwwroot/bigma.cc <span class="comment">#进入到需要git pull的网站目录</span></span><br><span class="line">git pull <span class="comment">#执行pull命令</span></span><br></pre></td></tr></table></figure>
<p>创建两个脚本后，要对脚本执行 chmod +x filename  为其添加执行的权限。</p>
<p>4.配置git公钥，公钥可以让你在服务器的本地仓库执行git pull的时候不需要输入密码。具体如何配置请参考<a href="http://git.mydoc.io/?t=180845" target="_blank" rel="noopener">配置公钥</a></p>
<p>5.为服务器端的PHP添加执行shell脚本的权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sudoers</span><br><span class="line"><span class="comment">#注释掉下面一行</span></span><br><span class="line"><span class="comment">#Defaults    requiretty</span></span><br><span class="line"><span class="comment">#末尾加入 www为http 用户 此处也可指定某个脚本无需密码</span></span><br><span class="line">www ALL=(ALL) NOPASSWD: ALL</span><br></pre></td></tr></table></figure>
<p>6.使用 <code>su www</code> 切换到 www 用户执行 <code>php pull.php</code> 测试能否成功执行脚本，执行成功将返回 git pull的回馈信息。</p>
<p>7.在码云的 WebHooks 中填入 pull.php 的url。本地执行git pull 看看网站目录是否自动更新了。</p>
<p>至此，使用 WebHooks 自动部署网站已配置完成。之后可以为pull.php加上密码验证提升安全性。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/08/08/Homestead/" class="prev">PREV</a><a href="/2017/06/30/gulp学习手记/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'ma-chen-cn';
var disqus_identifier = '2017/07/17/webhooks_for_gitoschina/';
var disqus_title = '使用码云的WebHooks实现网站的自动部署';
var disqus_url = 'http://bigma.cc/2017/07/17/webhooks_for_gitoschina/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//ma-chen-cn.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2023 <a href="http://bigma.cc">大马</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>. <a href="https://beian.miit.gov.cn/" target="_blank">冀ICP备13002956号-1</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-116335564-1",'auto');ga('send','pageview');</script></body></html>