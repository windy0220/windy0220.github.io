<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 控制反转与依赖注入[转载] · 大马的个人网站</title><meta name="description" content="控制反转与依赖注入[转载] - 大马"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://bigma.cc/atom.xml" title="大马的个人网站"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/avater.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">日志</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/1000/01/01/实验室/" target="_self" class="nav-list-link">实验室</a></li><li class="nav-list-item"><a href="http://weibo.com/80yang" target="_blank" class="nav-list-link">微博</a></li><li class="nav-list-item"><a href="https://github.com/windy0220" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">控制反转与依赖注入[转载]</h1><div class="post-info">2018年3月24日</div><div class="post-content"><p>之前一直不理解控制反转与依赖注入，直到我看到了这篇。<br><a id="more"></a><br>先说下自己的理解，calss A的内部需要实例化 class B，那么 class A就依赖于 class B，如果 class B 出现问题，那么势必导致 class A 也出现问题，这种就是依赖关系。如何解决？就是不在 class A 中控制实例化 class B 而是将 解决方案 作为参数注入到 class A中，那至于用什么解决方案，就交给第三方来控制（IOC）。那么这种思想就是控制反转，而实现的方式就是依赖注入。</p>
<h4 id="第一章：小明和他的手机"><a href="#第一章：小明和他的手机" class="headerlink" title="第一章：小明和他的手机"></a>第一章：小明和他的手机</h4><p>从前有个人叫小明</p>
<p>小明有三大爱好，抽烟，喝酒…… 咳咳，不好意思，走错片场了。应该是逛知乎、玩王者农药和抢微信红包<br><img src="/images/20180324001.jpg" alt="小明的三大爱好"><br>我们用一段简单的伪代码，来制造一个这样的小明<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ming</span> <span class="keyword">extends</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $_age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//逛知乎</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">play</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//玩农药</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">grab</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//抢红包</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但是，小明作为一个人类，没有办法仅靠自己就能实现以上的功能，他必须<b>依赖</b>一部手机，所以他买了一台iphone6，接下来我们来制造一个iphone6</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">iPhone6</span> <span class="keyword">extends</span> <span class="title">Iphone</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">($user=<span class="string">"某人"</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $user.<span class="string">"打开了知乎然后编了一个故事 \n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">play</span><span class="params">($user=<span class="string">"某人"</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $user.<span class="string">"打开了王者农药并送起了人头 \n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">grab</span><span class="params">($user=<span class="string">"某人"</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $user.<span class="string">"开始抢红包却只抢不发 \n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>小明非常珍惜自己的新手机，每天把它牢牢<b>控制</b>在手心里，所以小明变成了这个样子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ming</span> <span class="keyword">extends</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $_age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_name = <span class="string">'小明'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_age = <span class="number">26</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//……  省略若干代码</span></span><br><span class="line">        (<span class="keyword">new</span> iPhone6())-&gt;read(<span class="keyword">$this</span>-&gt;_name); <span class="comment">//逛知乎</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">play</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//……  省略若干代码</span></span><br><span class="line">        (<span class="keyword">new</span> iPhone6())-&gt;play(<span class="keyword">$this</span>-&gt;_name);<span class="comment">//玩农药</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">grab</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//……  省略若干代码</span></span><br><span class="line">        (<span class="keyword">new</span> iPhone6())-&gt;grab(<span class="keyword">$this</span>-&gt;_name);<span class="comment">//抢红包</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>今天是周六，小明不用上班，于是他起床，并依次逛起了知乎，玩王者农药，并抢了个红包。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ming = <span class="keyword">new</span> Ming();  <span class="comment">//小明起床</span></span><br><span class="line">$ming-&gt;read();</span><br><span class="line">$ming-&gt;play();</span><br><span class="line">$ming-&gt;grab();</span><br></pre></td></tr></table></figure>
<p>这个时候，我们可以在命令行里看到输出如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">小明打开了知乎然后编了一个故事 </span><br><span class="line">小明打开了王者农药并送起了人头 </span><br><span class="line">小明开始抢红包却只抢不发</span><br></pre></td></tr></table></figure></p>
<p>这一天，小明过得很充实，他觉得自己是世界上最幸福的人。</p>
<h4 id="第二章：-小明的快乐与忧伤"><a href="#第二章：-小明的快乐与忧伤" class="headerlink" title="第二章： 小明的快乐与忧伤"></a>第二章： 小明的快乐与忧伤</h4><p>小明和他的手机曾一起度过了一段美好的时光，一到空闲时刻，他就抱着手机，逛知乎，刷微博，玩游戏，他觉得自己根本不需要女朋友，只要有手机在身边，就满足了。</p>
<p>可谁能想到，一次次地系统更新彻底打碎了他的梦想，他的手机变得越来越卡顿，电池的使用寿命也越来越短，一直到某一天的寒风中，他的手机终于耐不住寒冷，头也不回地关了机。</p>
<p>小明很忧伤，他意识到，自己要换手机了。</p>
<p>为了能获得更好的使用体验，小明一咬牙，剁手了一台iphoneX，这部手机铃声很大，电量很足，还能双卡双待，小明很喜欢，但是他遇到一个问题，就是他之前过度依赖了原来那一部iPhone6，他们之间已经深深耦合在一起了，如果要换手机，他就要拿起刀来改造自己，把自己体内所有方法中的iphone6 都换成 iphoneX。</p>
<p><img src="/images/20180324002.jpg" alt="漫长的改造过程"><br>经历了漫长的改造过程，小明终于把代码中的 iphone6 全部换成了 iphoneX。虽然很辛苦，但是小明觉得他是快乐的。</p>
<p>于是小明开开心心地带着手机去上班了，并在回来的路上被小偷偷走了。为了应急，小明只好重新使用那部刚刚被遗弃的iphone6，但是一想到那漫长的改造过程，小明的心里就说不出的委屈，他觉得自己过于<b>依赖</b>手机了，为什么每次手机出什么问题他都要去改造他自己，这不仅仅是<b>过度耦合</b>，简直是<b>本末倒置</b>，他向天空大喊，我不要再<b>控制</b>我的手机了。</p>
<p>天空中的造物主，也就是作为程序员的我，听到了他的呐喊，我告诉他，你不用再控制你的手机了，交给我来管理，把控制权交给我。这就叫做<b>控制反转</b>。</p>
<h4 id="第三章：造物主的智慧"><a href="#第三章：造物主的智慧" class="headerlink" title="第三章：造物主的智慧"></a>第三章：造物主的智慧</h4><p>小明听到了我的话，他既高兴，又有一点害怕，他跪下来磕了几个头，虔诚地说到：“原来您就是传说中的造物主，巴格梅克上神。我听到您刚刚说了 控制反转 四个字，就是把手机的控制权从我的手里交给你，但这只是您的想法，是一种思想罢了，要用什么办法才能实现<b>控制反转</b>，又可以让我继续使用手机呢？”</p>
<p>“呵“，身为造物主的我在表现完不屑以后，扔下了四个大字，“依赖注入！”</p>
<p>接下来，伟大的我开始对小明进行惨无人道的改造，如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ming</span> <span class="keyword">extends</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $_age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $_phone; <span class="comment">//将手机作为自己的成员变量</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__construct</span><span class="params">($phone)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_name = <span class="string">'小明'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_age = <span class="number">26</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_phone = $phone;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"小明起床了 \n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//……  省略若干代码</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_phone-&gt;read(<span class="keyword">$this</span>-&gt;_name); <span class="comment">//逛知乎</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">play</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//……  省略若干代码</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_phone-&gt;play(<span class="keyword">$this</span>-&gt;_name);<span class="comment">//玩农药</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">grab</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//……  省略若干代码</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_phone-&gt;grab(<span class="keyword">$this</span>-&gt;_name);<span class="comment">//抢红包</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，我们来模拟运行小明的一天</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$phone = <span class="keyword">new</span> IphoneX(); <span class="comment">//创建一个iphoneX的实例</span></span><br><span class="line"><span class="keyword">if</span>($phone-&gt;isBroken())&#123;<span class="comment">//如果iphone不可用，则使用旧版手机</span></span><br><span class="line">    $phone = <span class="keyword">new</span> Iphone6();</span><br><span class="line">&#125;</span><br><span class="line">$ming = <span class="keyword">new</span> Ming($phone);<span class="comment">//小明不用关心是什么手机，他只要玩就行了。</span></span><br><span class="line">$ming-&gt;read();</span><br><span class="line">$ming-&gt;play();</span><br><span class="line">$ming-&gt;grab();</span><br></pre></td></tr></table></figure>
<p>我们先看一下iphoneX 是否可以使用，如果不可以使用，则直接换成iphone6,然后唤醒小明，并把手机塞到他的手里，换句话说，把他所依赖的手机直接注入到他的身上，他不需要关心自己拿的是什么手机，他只要直接使用就可以了。</p>
<p>这就是<b>依赖注入</b>。</p>
<h4 id="第四章：小明的感悟"><a href="#第四章：小明的感悟" class="headerlink" title="第四章：小明的感悟"></a>第四章：小明的感悟</h4><p>小明的生活开始变得简单了起来，而他把省出来的时间都用来写笔记了，他在笔记本上这样写到</p>
<blockquote>
<p>我曾经有很强的控制欲，过度依赖于我的手机，导致我和手机之间耦合程度太高，只要手机出现一点点问题，我都要改造我自己，这实在是既浪费时间又容易出问题。自从我把控制权交给了造物主，他每天在唤醒我以前，就已经替我选好了手机，我只要按照平时一样玩手机就可以了，根本不用关心是什么手机。即便手机出了问题，也可以由造物主直接搞定，不需要再改造我自己了，我现在买了七部手机，都交给了造物主，每天换一部，美滋滋！<br>我也从其中获得了这样的感悟： 如果一个类A 的功能实现需要借助于类B，那么就称类B是类A的依赖，如果在类A的内部去实例化类B，那么两者之间会出现较高的耦合，一旦类B出现了问题，类A也需要进行改造，如果这样的情况较多，每个类之间都有很多依赖，那么就会出现牵一发而动全身的情况，程序会极难维护，并且很容易出现问题。要解决这个问题，就要把A类对B类的控制权抽离出来，交给一个第三方去做，把控制权反转给第三方，就称作控制反转（IOC Inversion Of Control）。控制反转是一种思想，是能够解决问题的一种可能的结果，而依赖注入（Dependency Injection）就是其最典型的实现方法。由第三方（我们称作IOC容器）来控制依赖，把他通过构造函数、属性或者工厂模式等方法，注入到类A内，这样就极大程度的对类A和类B进行了解耦。</p>
</blockquote>
<h4 id="第五章-小明的困惑"><a href="#第五章-小明的困惑" class="headerlink" title="第五章 小明的困惑"></a>第五章 小明的困惑</h4><p>有一天，小明发现自己在想阅读知乎的时候，读到了这样一行文字。<br>未完待续…</p>
<blockquote>
<p>本篇转载自知乎胡小国 <a href="https://zhuanlan.zhihu.com/p/33492169" target="_blank" rel="noopener">原文链接</a></p>
</blockquote>
</div></article></div></main><footer><div class="paginator"><a href="/2018/03/28/javascript高级程序设计-阅读笔记/" class="prev">PREV</a><a href="/2018/03/15/使用纯css实现radio的美化/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'ma-chen-cn';
var disqus_identifier = '2018/03/24/控制反转与依赖注入/';
var disqus_title = '控制反转与依赖注入[转载]';
var disqus_url = 'http://bigma.cc/2018/03/24/控制反转与依赖注入/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//ma-chen-cn.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2023 <a href="http://bigma.cc">大马</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>. <a href="https://beian.miit.gov.cn/" target="_blank">冀ICP备13002956号-1</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-116335564-1",'auto');ga('send','pageview');</script></body></html>